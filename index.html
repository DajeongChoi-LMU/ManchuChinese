<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manchu–Chinese Digital Texts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: serif; margin: 40px; max-width: 1200px; }
    nav a { margin-right: 12px; text-decoration: none; }
    .split { display: grid; grid-template-columns: 1.3fr 1fr; gap: 20px; min-height: 80vh; }
    .pane { border: 1px solid #ccc; padding: 12px; overflow: auto; background: #fff; }
    .pageimg { max-width: 100%; height: auto; display: block; }
    .parallel { line-height: 1.8; white-space: pre-wrap; }
    .toolbar { display: flex; align-items: center; gap: 10px; margin: 10px 0 16px; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    @media (max-width: 900px) { .split { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<h1>Manchu–Traditional Chinese Digital Corpus </h1>

<nav>
  <a href="#about">About</a>
  <a href="#viewer">Viewer</a>
</nav>
<hr>

<h2 id="about">About</h2>
<p>
This pilot shows a synchronized IIIF viewer: the page image on the left and the corresponding text on the right.
</p>

<div class="toolbar">
  <button id="prevBtn" class="btn">◀ Prev</button>
  <div>Page <span id="cur">1</span> / <span id="tot">–</span></div>
  <button id="nextBtn" class="btn">Next ▶</button>
  <select id="jump" class="btn"></select>
</div>

<section id="viewer" class="split">
  <div class="pane left">
    <img id="img" class="pageimg" src="" alt="page image">
    <p style="margin-top:8px;font-size:0.9em;color:#666;">
      If the image does not load, open the source:
      <a id="imgLink" href="#" target="_blank" rel="noopener">image URL</a>
    </p>
  </div>

  <div class="pane right">
    <h2 id="pagelabel">Page</h2>
    <div id="text" class="parallel"></div>
  </div>
</section>

<script>
/* ===== 1) IIIF manifest: 절대경로 고정 ===== */
const MANIFEST_URL =
  "https://dajeongchoi-lmu.github.io/ManchuChinese/3306131067.manifest.json?v=2";

/* ===== 2) 텍스트 매핑 ===== */
const pageTexts = [];
const textsByLabel = {
  "上:1r [163]": `leolen gisusen bithe dergi<br/>
論語 上<br/><br/>
tacingga ujui fiyelen<br/>
學而 第一<br/><br/>
1<br/>
fudzi hendume<br/>
子曰<br/><br/>
tacimbime erinderi urebuci<br/>
學而時習之<br/><br/>
inu urgun wakao<br/>
不亦說乎<br/><br/>
gucuse bifi goro jici<br/>
有朋自遠方來<br/><br/>
inu sebjen wakao<br/>
不亦樂乎<br/><br/>
niyalma sarkv seme korsorakv oci<br/>
人不知而不慍<br/><br/>
inu ambasa saisa wakao<br/>
不亦君子乎<br/><br/>
2<br/>
iodzi hendume<br/>
有子曰<br/><br/>
terei yabun hiyooxun deocin bime<br/>
其爲人也孝弟<br/><br/>
dergi be necire de amurangge komso dere<br/>
而好犯上者鮮矣<br/><br/>
dergi be necire de amuran akv bime<br/>
不好犯上<br/><br/>`,
  "上:1v [164]": `facuhvn be deribure de amurangga akv kai<br/>
而好作亂者 未之有也<br/><br/>
ambasa saisa fulehe be kicembi<br/>
君子務本<br/><br/>
fulehe ilici doro banjinambi<br/>
本立而道生<br/><br/>
hiyooxun deocin serengge<br/>
孝弟也者<br/><br/>
tere gosin be yabure fulehe dere<br/>
其爲仁之本與<br/><br/>
3<br/>
fudzi hendume<br/>
子曰<br/><br/>
faksi gisun araha cira de<br/>
巧言令色<br/><br/>
gosin komso dere<br/>
鮮矣仁<br/><br/>
4<br/>
dzengdzi hendume<br/>
曾子曰<br/><br/>
bi inenggideri ilan hacin be mini beyede kimcimbi<br/>
吾日三省吾身<br/><br/>
niyalmai jalin bodoro de tondo akv ayoo<br/>
爲人謀而不忠乎<br/><br/>`
};

/* ===== 3) manifest 로딩 & 캔버스 파싱 ===== */
async function loadManifest(url){
  console.log("[manifest] GET", url);
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok){
    const body = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${body.slice(0,160)}`);
  }
  return res.json();
}
function getCanvases(m){
  if (Array.isArray(m.items) && m.items.length) return m.items;                 // IIIF v3
  if (m.sequences?.[0]?.canvases) return m.sequences[0].canvases;               // IIIF v2
  throw new Error("No canvases found in manifest");
}
function canvasLabel(c){
  const lbl = c.label;
  if (typeof lbl === "string") return lbl;
  if (lbl?.none?.[0]) return lbl.none[0];
  if (lbl?.en?.[0])   return lbl.en[0];
  return c.id || c['@id'] || "Page";
}

/* ===== 4) 견고한 IIIF 이미지 URL 생성 + 캐시버스터 ===== */
function imageUrlFromCanvas(c, width = 1400){
  // v3: AnnotationPage → Annotation → body
  let body = null;
  try {
    const ap  = c.items?.[0];
    const ann = ap?.items?.[0];
    body = ann?.body;
    if (Array.isArray(body)) body = body[0]; // Choice 대응
  } catch(_) {}

  const pickServiceBase = (obj) => {
    if (!obj) return null;
    const svc = Array.isArray(obj.service) ? obj.service[0] : obj.service;
    let base = svc?.id || svc?.['@id'];
    if (base && /\/info\.json$/.test(base)) base = base.replace(/\/info\.json$/, '');
    return base || null;
  };

  // 1) service 기반(정석)
  let base = serviceBase(body);
  if (base) return `${base}/full/${width},/0/default.jpg`;

  // 2) body가 완성 JPG일 때
  if (body?.id && /\.(jpg|jpeg|png)$/i.test(body.id)) return `${body.id}?ts=${Date.now()}`;

  // 3) v2 fallback
  const img = c.images?.[0]?.resource;
  if (img) {
    const base2 = pickServiceBase(img);
    if (base2) return `${base2}/full/${width},/0/default.jpg?ts=${Date.now()}`;
    const direct = img['@id'] || img.id;
    if (direct && /\.(jpg|jpeg|png)$/i.test(direct)) return `${direct}?ts=${Date.now()}`;
  }

  // 4) 이미 완성된 Image API 경로가 들어온 경우
  if (body?.id && /\/full\//.test(body.id)) return `${body.id}?ts=${Date.now()}`;

  console.warn("IIIF image resolve failed for canvas", c);
  return "";
}

/* ===== 5) 렌더링 ===== */
let canvases = [];
let idx = 0;

const imgEl   = document.getElementById("img");
const linkEl  = document.getElementById("imgLink");
const textEl  = document.getElementById("text");
const labelEl = document.getElementById("pagelabel");
const curEl   = document.getElementById("cur");
const totEl   = document.getElementById("tot");
const jumpEl  = document.getElementById("jump");

function render(){
  const c = canvases[idx];
  let url = imageUrlFromCanvas(c);
  console.log("[image]", url);

  // 기본 로드
  imgEl.onerror = null;
  imgEl.src = url;
  linkEl.href = url;

  // 실패 시 규격 바꿔 재시도(!w,h → native.jpg)
  imgEl.onerror = () => {
    if (url.includes("/full/") && url.includes("/default.jpg")) {
      const alt1 = url.replace(/\/full\/\d+,\/0\/default\.jpg/, "/full/!1400,1400/0/default.jpg");
      console.log("[retry-1]", alt1);
      imgEl.onerror = () => {
        const alt2 = alt1.replace("/default.jpg", "/native.jpg");
        console.log("[retry-2]", alt2);
        imgEl.onerror = null;
        imgEl.src = alt2;
        linkEl.href = alt2;
      };
      imgEl.src = alt1;
      linkEl.href = alt1;
    }
  };

  const label = canvasLabel(c);
  labelEl.textContent = label;
  textEl.innerHTML = textsByLabel[label] ?? pageTexts[idx] ?? "";

  curEl.textContent = String(idx + 1);
  jumpEl.value = String(idx);
}

function fillJump(){
  jumpEl.innerHTML = "";
  canvases.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i+1}. ${canvasLabel(c)}`;
    jumpEl.appendChild(opt);
  });
}

/* ===== 6) 이벤트 ===== */
document.getElementById("prevBtn").onclick = () => { idx = (idx - 1 + canvases.length) % canvases.length; render(); };
document.getElementById("nextBtn").onclick = () => { idx = (idx + 1) % canvases.length; render(); };
jumpEl.onchange = e => { idx = parseInt(e.target.value, 10); render(); };
document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft")  document.getElementById("prevBtn").click();
  if (e.key === "ArrowRight") document.getElementById("nextBtn").click();
});

/* ===== 7) 초기화 ===== */
(async function init(){
  try {
    const manifest = await loadManifest(MANIFEST_URL);
    canvases = getCanvases(manifest);
    totEl.textContent = String(canvases.length);
    while (pageTexts.length < canvases.length) pageTexts.push("");
    fillJump();
    render();
  } catch(err){
    console.error(err);
    alert("IIIF manifest 로딩 실패: 콘솔(F12)에서 오류 메시지를 확인하세요.");
  }
})();
</script>

</body>
</html>
