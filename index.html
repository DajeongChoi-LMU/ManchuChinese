<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manchu–Chinese Digital Texts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: serif; margin: 0; }
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

    /* --- Sidebar (Accordion) --- */
    .sidebar {
      border-right: 1px solid #e5e5e5; background:#fafafa; padding:16px;
      position: sticky; top:0; height:100vh; overflow:auto;
    }
    .brand { font-weight:700; margin-bottom:12px; }
    .cat { margin:10px 0; border:1px solid #ddd; border-radius: 12px; background:#fff; }
    .cat-header {
      width:100%; text-align:left; padding:10px 12px; font-weight:700; cursor:pointer;
      background:#f3f3f3; border:0; border-bottom:1px solid #eee; border-radius:12px 12px 0 0;
    }
    .cat-items { padding:8px 10px; display:none; }
    .cat.open .cat-items { display:block; }

    .edition-btn {
      display:block; width:100%; padding:8px 10px; margin:6px 0;
      border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; text-align:left;
    }
    .edition-btn.active { background:#eee; border-color:#ccc; }
    .edition-btn[disabled] { opacity:.55; cursor:not-allowed; }

    /* --- Main / Viewer --- */
    .main { padding:24px; max-width:1200px; margin:0 auto; }
    .toolbar { display:flex; align-items:center; gap:10px; margin:10px 0 16px; }
    .btn { padding:6px 10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
    .split { display:grid; grid-template-columns: 1.3fr 1fr; gap:20px; min-height:70vh; }
    .pane { border:1px solid #ccc; padding:12px; overflow:auto; background:#fff; }
    .pageimg { max-width:100%; height:auto; display:block; }
    .parallel { line-height:1.8; white-space:pre-wrap; }
    .pdfframe { width:100%; height:calc(100vh - 220px); border:0; }

    @media (max-width:900px){
      .layout{grid-template-columns:1fr;}
      .sidebar{position:static;height:auto;}
      .split{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>

<div class="layout">
  <!-- 왼쪽: 카테고리 아코디언 + 판본 목록 -->
  <aside class="sidebar">
    <div class="brand">Manchu–Chinese bilingual editions of Confucian classics</div>
    <div id="editionList"></div>
  </aside>

  <!-- 오른쪽: 뷰어 -->
  <main class="main">
    <h1>A Digital Corpus of Manchu–Chinese Bilingual Editions of Confucian Classics </h1>

    <nav style="margin-bottom:8px;">
      <a href="#about">About</a>
      <a href="#viewer">Viewer</a>
    </nav>
    <hr>

    <h2 id="about">About</h2>
    <p>
      On the left, the image of the classical manuscript is displayed, and on the right, the corresponding Manchu–Chinese parallel text appears.
    </p>

    <div class="toolbar">
      <button id="prevBtn" class="btn">◀ Prev</button>
      <div>Page <span id="cur">1</span> / <span id="tot">–</span></div>
      <button id="nextBtn" class="btn">Next ▶</button>
      <select id="jump" class="btn" title="Jump to page"></select>
    </div>

    <section id="viewer" class="split">
      <!-- ✨ 왼쪽 뷰: 모드(IIIF / PDF)에 따라 동적으로 채움 -->
      <div class="pane left" id="leftPane"></div>

      <div class="pane right">
        <h2 id="pagelabel">Page</h2>
        <div id="text" class="parallel"></div>
      </div>
    </section>
  </main>
</div>

<!-- 판본 목록 (레포 루트의 editions.js) -->
<script src="editions.js"></script>

<script>
const EDITION_TEXTS = {
  japan_sishu_1691: {
    pageTexts: [
      "",
      "",
      "",
      
      `xang luwen ioi<br/>
論語 上<br/>
tacikvi uju<br/>
學而 第一<br/><br/>
kungdzi hendume<br/>
子曰<br/>
tacimbime einderi urebuci<br/>
學而時習之<br/>
inu urgun wakao<br/>
不亦說乎<br/>
gucuse bifi goro baci jicibr/>
有朋自遠方來<br/>
inu sebjen wakao<br/>
不亦樂乎<br/>
niyalma sarkv seme korsorakv oci<br/>
人不知而不慍<br/>
inu ambasa saisa wakao<br/>
不亦君子乎<br/>
2<br/>
iodzi hendume<br/>
有子曰<br/>
terei yabun hiyoocun deocin bime<br/>
其爲人也孝弟<br/>
dergi be necire amuran ningge komso<br/> 
而好犯上者鮮矣<br/>
dergi be necire de amuran akv bime<br/>
不好犯上<br/>
facuhvn be deribure amuran ningge akv kai<br/> 
而好作亂者 未之有也<br/>
ambasa saisa fulehe be kicembi<br/>
君子務本<br/>
fulehe ilici doro banjinambi<br/>
本立而道生<br/>
hiyooxulambi deocilembi serengge<br/> 
孝弟也者<br/>
tere gosin be yabure fulehe dere<br/>
其爲仁之本與<br/>`, 

     `kungdzi hendume<br/>
子曰<br/>
faksi gisun araha cira<br/>
巧言令色<br/>
gosin komso dere<br/>
鮮矣仁<br/>
4<br/>
dzengdzi hendume<br/>
曾子曰<br/>
bi inenggideri ilan hacin i mini beye be kimcimbi<br/>
吾日三省吾身<br/> 
niyalmai jalin bodoro de tondo akv ayoo<br/>
爲人謀而不忠乎<br/> 
gucusei baru guculere de akdun akv ayoo<br/>
與朋友交而不信乎<br/> 
ulahan be ureburakv ayoo seme<br/>
傳不習乎<br/>
5<br/>
kungdzi hendume<br/>
子曰<br/>
minggan sejen i gurun be dasara de<br/>
道千乘之國<br/>
baita be ginggulembime akdun<br/>
敬事而信<br/>
kemneme baitalambime niyalma be gosimbi<br/>
節用而愛人<br/> 
irgen be takvraci erilembi<br/>
使民以時<br/> 
6<br/>
kungdzi hendume<br/>
子曰<br/>
deote juse dosici hiyooxula<br/>
弟子入則孝<br/>
tucici deocile<br/>
出則弟<br/>
ginggulembime akdun oso<br/>
謹而信<br/> 
geren be gemu gosi<br/>
汎愛衆<br/>
gosin de hajila<br/> 
而親仁<br/>
yabume funcehe hvsun bici<br/>
行有餘力<br/>
xu be taci<br/>
則以學文<br/>
7<br/>
dzi hiya hendume<br/>
子夏曰<br/>
sain be saixame boco be guribure<br/>
賢賢易色<br/>
ama eme be weilere de hvsun be akvmbume mutere<br/>
事父母能竭其力<br/>
ejen be weilere de beyebe waliyatai obume mutere<br/>
事君能致其身<br/>
gucusei baru guculere de gisun akdun ojoro ohode<br/>
與朋友交言而有信<br/>
udu tacihakv sehe seme<br/>
雖曰未學<br/>
bi urunakv tacihabi sembi<br/>
吾必謂之學矣<br/>
8<br/>
kungdzi hendume<br/>
子曰<br/>
ambasa saisa ujen akv oci horon akv<br/>
君子不重則不威<br/>
taciha seme beki akv<br/>
學則不固<br/>
tondo akdun be da obu<br/>
主忠信<br/>
beye de isirakvngge de ume guculere<br/>
無友不如己者<br/> 
endebuhe be halara de ume sengguwendere<br/>
過則勿憚改<br/>
9<br/>
dzengdzi hendume<br/>
曾子曰<br/>
duben be olhoro goro be amcara oci<br/>
愼終追遠<br/>
irgen i erdemu jiramin de dahambi<br/>
民德歸厚矣<br/>
10<br/>
dzi kin dzi gung de fonjime<br/>
子禽問於子貢曰<br/>
fudzi tere gurun de isinaha de<br/>
夫子 至於是邦也<br/>
urunakv terei dasan be donjirengge<br/>
必聞其政<br/>
bairedeo<br/>
求之與<br/>
eici alaradeo<br/> 
抑與之與<br/>`
    ],
    textsByLabel: {}
  },

  
  berlin_sishu_1755: {
    pageTexts: [],
    textsByLabel: {
      "上:1r [163]": `leolen gisusen bithe dergi<br/>
論語 上<br/>
tacingga ujui fiyelen<br/>
學而 第一<br/>
1<br/>
fudzi hendume<br/>
子曰<br/>
tacimbime erinderi urebuci<br/>
學而時習之<br/>
inu urgun wakao<br/>
不亦說乎<br/>
gucuse bifi goro jici<br/>
有朋自遠方來<br/>
inu sebjen wakao<br/>
不亦樂乎<br/>
niyalma sarkv seme korsorakv oci<br/>
人不知而不慍<br/>
inu ambasa saisa wakao<br/>
不亦君子乎<br/>
2<br/>
iodzi hendume<br/>
有子曰<br/>
terei yabun hiyooxun deocin bime<br/>
其爲人也孝弟<br/>
dergi be necire de amurangge komso dere<br/>
而好犯上者鮮矣<br/>
dergi be necire de amuran akv bime<br/>
不好犯上<br/><br/>`,
      "上:1v [164]": `facuhvn be deribure de amurangga akv kai<br/>
而好作亂者 未之有也<br/>
ambasa saisa fulehe be kicembi<br/>
君子務本<br/>
fulehe ilici doro banjinambi<br/>
本立而道生<br/>
hiyooxun deocin serengge<br/>
孝弟也者<br/>
tere gosin be yabure fulehe dere<br/>
其爲仁之本與<br/>
3<br/>
fudzi hendume<br/>
子曰<br/>
faksi gisun araha cira de<br/>
巧言令色<br/>
gosin komso dere<br/>
鮮矣仁<br/>
4<br/>
dzengdzi hendume<br/>
曾子曰<br/>
bi inenggideri ilan hacin be mini beyede kimcimbi<br/>
吾日三省吾身<br/>
niyalmai jalin bodoro de tondo akv ayoo<br/>
爲人謀而不忠乎<br/>`
    }
  }
};
</script>

<!-- 뷰어 로직 -->
<script>
let canvases = [];
let idx = 0;
let currentEdition = (window.EDITIONS && window.EDITIONS[0]) || null;

const leftPane = document.getElementById("leftPane");
const textEl  = document.getElementById("text");
const labelEl = document.getElementById("pagelabel");
const curEl   = document.getElementById("cur");
const totEl   = document.getElementById("tot");
const jumpEl  = document.getElementById("jump");

/* -------- (A) 왼쪽 뷰 모드 전환 -------- */
function showIiifImageMode() {
  leftPane.innerHTML = `
    <img id="img" class="pageimg" src="" alt="page image">
    <p style="margin-top:8px;font-size:0.9em;color:#666;">
      If the image does not load, open the source:
      <a id="imgLink" href="#" target="_blank" rel="noopener">image URL</a>
    </p>
  `;
}
function showPdfMode(pdfUrl) {
  leftPane.innerHTML = `
    <object data="${pdfUrl}" type="application/pdf" class="pdfframe">
      <p style="margin-top:8px;font-size:0.9em;color:#666;">
        PDF embed is blocked.
        <a href="${pdfUrl}" target="_blank" rel="noopener">Open in a new tab</a>
      </p>
    </object>
  `;
  labelEl.textContent = "PDF view";
  totEl.textContent = "–";
  curEl.textContent = "1";
  jumpEl.innerHTML = "";
}

/* -------- (B) 사이드바 렌더 -------- */
function renderEditionList() {
  const box = document.getElementById("editionList");
  box.innerHTML = "";

  const groups = {};
  (window.EDITIONS || []).forEach(ed => {
    const cat = ed.category || "Others";
    (groups[cat] ||= []).push(ed);
  });

  const orderedCats = [
    "經書類(Confucian canon)",
    "成語集類(Manchu–Chinese bilingual glossaries)",
    "繙譯考試題(Questions and Answers from the Translation Examinations)"
  ];
  const allCats = [...orderedCats, ...Object.keys(groups).filter(c => !orderedCats.includes(c))];

  allCats.forEach(catTitle => {
    if (!groups[catTitle]) return;

    const sec = document.createElement("div");
    sec.className = "cat open";

    const header = document.createElement("button");
    header.className = "cat-header";
    header.textContent = catTitle;
    header.onclick = () => sec.classList.toggle("open");
    sec.appendChild(header);

    const items = document.createElement("div");
    items.className = "cat-items";

    groups[catTitle]
      .sort((a,b)=>(a.year||"").localeCompare(b.year||""))
      .forEach(ed => {
        const btn = document.createElement("button");
        const isActive = (currentEdition && ed.key === currentEdition.key);
        const hasSource = (ed.manifest && ed.manifest.trim()) || (ed.pdf && ed.pdf.trim());

        btn.className = "edition-btn" + (isActive ? " active" : "");
        btn.textContent = ed.title;

        if (hasSource) {
          btn.onclick = () => switchEdition(ed);
        } else {
          btn.disabled = true;
          btn.title = "아직 업로드 전입니다. (manifest 또는 pdf가 필요)";
        }
        items.appendChild(btn);
      });

    sec.appendChild(items);
    box.appendChild(sec);
  });
}

/* -------- (C) IIIF 유틸 -------- */
async function loadManifest(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`Manifest fetch failed: ${res.status}`);
  return res.json();
}
function getCanvases(m){
  if (Array.isArray(m.items) && m.items.length) return m.items;   // v3
  if (m.sequences?.[0]?.canvases) return m.sequences[0].canvases; // v2
  throw new Error("No canvases found in manifest");
}
function canvasLabel(c){
  const lbl = c.label;
  if (typeof lbl === "string") return lbl;
  if (lbl?.none?.[0]) return lbl.none[0];
  if (lbl?.en?.[0])   return lbl.en[0];
  return c.id || c['@id'] || "Page";
}
function imageUrlFromCanvas(c, width = 1400){
  let body = null;
  try {
    const ap  = c.items?.[0];
    const ann = ap?.items?.[0];
    body = Array.isArray(ann?.body) ? ann.body[0] : ann?.body; // Choice 대응
  } catch(_) {}

  const pickServiceBase = (obj) => {
    if (!obj) return null;
    const svc = Array.isArray(obj.service) ? obj.service[0] : obj.service;
    let base = svc?.id || svc?.['@id'] || null;
    if (base && /\/info\.json$/.test(base)) base = base.replace(/\/info\.json$/, '');
    return base;
  };

  // 1) 정석: Image API 서비스
  let base = pickServiceBase(body);
  if (base) return `${base}/full/${width},/0/default.jpg`;

  // 2) 완성 이미지 파일
  if (body?.id && /\.(jpe?g|png)$/i.test(body.id)) return body.id;

  // 3) IIIF v2 fallback
  const img = c.images?.[0]?.resource;
  if (img) {
    const base2 = pickServiceBase(img);
    if (base2) return `${base2}/full/${width},/0/default.jpg`;
    const direct = img['@id'] || img.id;
    if (direct && /\.(jpe?g|png)$/i.test(direct)) return direct;
  }

  // 4) 완성된 Image API 경로
  if (body?.id && /\/full\//.test(body.id)) return body.id;

  return "";
}

/* -------- (D) 렌더 -------- */
function render(){
  const c = canvases[idx];
  const url = imageUrlFromCanvas(c);

  const imgEl  = document.getElementById("img");
  const linkEl = document.getElementById("imgLink");
  if (imgEl)  imgEl.src  = url;
  if (linkEl) linkEl.href = url;

  const label = canvasLabel(c);
  labelEl.textContent = label;

  // 현재 판본의 전사 매핑 우선 사용
  const edTxt          = EDITION_TEXTS[currentEdition?.key] || {};
  const edPageTexts    = edTxt.pageTexts || [];
  const edTextsByLabel = edTxt.textsByLabel || {};
  textEl.innerHTML = edTextsByLabel[label] ?? edPageTexts[idx] ?? "";

  curEl.textContent = String(idx + 1);
  jumpEl.value = String(idx);
}
function fillJump(){
  jumpEl.innerHTML = "";
  canvases.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i+1}. ${canvasLabel(c)}`;
    jumpEl.appendChild(opt);
  });
}

/* -------- (E) 이벤트 -------- */
document.getElementById("prevBtn").onclick = () => { idx = (idx - 1 + canvases.length) % canvases.length; render(); };
document.getElementById("nextBtn").onclick = () => { idx = (idx + 1) % canvases.length; render(); };
jumpEl.onchange = e => { idx = parseInt(e.target.value, 10); render(); };
document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft")  document.getElementById("prevBtn").click();
  if (e.key === "ArrowRight") document.getElementById("nextBtn").click();
});

/* -------- (F) 판본 전환 -------- */
async function switchEdition(edition){
  currentEdition = edition;
  renderEditionList(); // active 갱신

  const hasManifest = edition.manifest && edition.manifest.trim();
  const hasPdf = edition.pdf && edition.pdf.trim();

  // PDF-only 판본
  if (!hasManifest && hasPdf) {
    canvases = [];
    idx = 0;
    showPdfMode(edition.pdf);
    textEl.innerHTML = ""; // 필요 시 설명/전사 채우기
    return;
  }

  // IIIF 판본
  const manifest = await loadManifest(edition.manifest);
  canvases = getCanvases(manifest);
  totEl.textContent = String(canvases.length);

  idx = 0;
  showIiifImageMode();   // 이미지 뷰로 교체
  fillJump();
  render();

  // 필요 시 별도 textUrl 사용
  if (edition.textUrl && !textEl.innerHTML.trim()) {
    try {
      const r = await fetch(edition.textUrl, { cache: "no-store" });
      textEl.innerHTML = await r.text();
    } catch(_) {}
  }
}

/* -------- (G) 초기화 -------- */
(async function init(){
  if (!currentEdition) { alert("EDITIONS가 비어 있습니다."); return; }
  renderEditionList();
  await switchEdition(currentEdition);
})();
</script>

</body>
</html>
