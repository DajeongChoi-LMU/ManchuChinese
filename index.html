<script>
// --- 0) 현재 페이지의 베이스 경로 계산 (프로젝트 페이지 안전) ---
const BASE = (function () {
  // 예) /ManchuChinese/  또는 /ManchuChinese/subdir/
  const p = location.pathname;
  return p.endsWith('/') ? p.slice(0, -1) : p.replace(/\/[^/]*$/, '');
})();

// --- 1) IIIF Manifest 경로 ---
const MANIFEST_URL = `${BASE}/3306131067.manifest.json?v=1`;

// --- 2) 라벨별 전사 텍스트(드롭다운에 보이는 라벨과 정확히 일치해야 함) ---
const textsByLabel = {
  "上:1r [163]": `leolen gisusen bithe  dergi<br/>
論語 上<br/><br/>
tacingga ujui fiyelen<br/>
學而 第一<br/><br/>
1<br/>
fudzi hendume<br/>
子曰<br/><br/> 
tacimbime erinderi urebuci<br/>
學而時習之<br/><br/> 
inu urgun wakao<br/>
不亦說乎<br/><br/>
gucuse bifi goro jici<br/>
有朋自遠方來<br/><br/> 
inu sebjen wakao<br/>
不亦樂乎<br/><br/>
niyalma sarkv seme korsorakv oci<br/>
人不知而不慍<br/><br/> 
inu ambasa saisa wakao<br/>
不亦君子乎<br/><br/>
2<br/>
iodzi hendume<br/>
有子曰<br/><br/> 
terei yabun hiyooxun deocin bime<br/>
其爲人也孝弟<br/><br/> 
dergi be necire de amurangge komso dere<br/> 
而好犯上者鮮矣<br/><br/> 
dergi be necire de amuran akv bime<br/>
不好犯上<br/><br/>`,

  "上:1v [164]": `facuhvn be deribure de amurangga akv kai<br/> 
而好作亂者 未之有也<br/><br/>
ambasa saisa fulehe be kicembi<br/>
君子務本<br/><br/>
fulehe ilici doro banjinambi<br/>
本立而道生<br/><br/>
hiyooxun deocin serengge<br/> 
孝弟也者<br/><br/> 
tere gosin be yabure fulehe dere<br/>
其爲仁之本與<br/><br/>
3<br/>
fudzi hendume<br/>
子曰<br/><br/> 
faksi gisun araha cira de<br/>
巧言令色<br/><br/>
gosin komso dere<br/>
鮮矣仁<br/><br/>
4<br/>
dzengdzi hendume<br/>
曾子曰<br/><br/> 
bi inenggideri ilan hacin be mini beyede kimcimbi<br/>
吾日三省吾身<br/><br/> 
niyalmai jalin bodoro de tondo akv ayoo<br/>
爲人謀而不忠乎<br/><br/>`
};

// --- 4) IIIF manifest 로딩/파싱 ---
async function loadManifest(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`Manifest fetch failed: ${res.status}`);
  return await res.json();
}
function getCanvases(manifest){
  if (Array.isArray(manifest.items) && manifest.items.length) return manifest.items;          // v3
  if (manifest.sequences?.[0]?.canvases) return manifest.sequences[0].canvases;              // v2
  throw new Error("No canvases found in manifest");
}
function canvasLabel(c){
  const lbl = c.label;
  if (typeof lbl === "string") return lbl;
  if (lbl?.none?.[0]) return lbl.none[0];
  if (lbl?.en?.[0]) return lbl.en[0];
  return c.id || c['@id'] || "Page";
}
function imageUrlFromCanvas(c, width=1400){
  try { // v3
    const body = c.items[0].items[0].body;
    const svc = Array.isArray(body.service) ? body.service[0] : body.service;
    let base = (svc && (svc.id || svc['@id'])) || body.id || body['@id'];
    if (!base) throw new Error("no service/id");
    base = base.replace(/\/info\.json$/,'');
    return `${base}/full/${width},/0/default.jpg`;
  } catch(_e){ // v2 fallback
    const img = c.images?.[0]?.resource;
    const svc = img?.service && (img.service['@id'] || img.service.id);
    if (svc) return `${svc.replace(/\/info\.json$/,'')}/full/${width},/0/default.jpg`;
    if (img && (img['@id'] || img.id)) return img['@id'] || img.id;
    return "";
  }
}

// --- 5) 상태 & 요소 참조 ---
let canvases = [];
let idx = 0;
const imgEl   = document.getElementById("img");
const linkEl  = document.getElementById("imgLink");
const textEl  = document.getElementById("text");
const labelEl = document.getElementById("pagelabel");
const curEl   = document.getElementById("cur");
const totEl   = document.getElementById("tot");
const jumpEl  = document.getElementById("jump");

// --- 6) 렌더 ---
function render(){
  const c = canvases[idx];
  const url = imageUrlFromCanvas(c);
  imgEl.src = url;
  linkEl.href = url;

  const label = canvasLabel(c);
  labelEl.textContent = label;

  // 라벨 매핑 → 배열 순서 매핑 → 빈 문자열
  textEl.innerHTML = textsByLabel[label] ?? pageTexts[idx] ?? "";

  curEl.textContent = String(idx + 1);
  jumpEl.value = String(idx);
}
function fillJump(){
  jumpEl.innerHTML = "";
  canvases.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i+1}. ${canvasLabel(c)}`;
    jumpEl.appendChild(opt);
  });
}

// --- 7) 이벤트 ---
document.getElementById("prevBtn").onclick = () => { idx = (idx - 1 + canvases.length) % canvases.length; render(); };
document.getElementById("nextBtn").onclick = () => { idx = (idx + 1) % canvases.length; render(); };
jumpEl.onchange = e => { idx = parseInt(e.target.value, 10); render(); };
document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft")  document.getElementById("prevBtn").click();
  if (e.key === "ArrowRight") document.getElementById("nextBtn").click();
});

// --- 8) 초기화 ---
(async function init(){
  try {
    const manifest = await loadManifest(MANIFEST_URL);
    canvases = getCanvases(manifest);
    totEl.textContent = String(canvases.length);
    while (pageTexts.length < canvases.length) pageTexts.push(""); // 안전 보정
    fillJump();
    render();
  } catch(err){
    console.error(err);
    alert("IIIF manifest를 불러오지 못했습니다. 파일 경로/이름을 확인하세요.");
  }
})();
</script>
